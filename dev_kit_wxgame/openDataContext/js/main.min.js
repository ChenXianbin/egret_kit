var egret=window.egret,__reflect=this&&this.__reflect||function(e,t,n){e.__class__=t,n?n.push(t):n=[t],e.__types__=e.__types__?n.concat(e.__types__):n},__extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);n.prototype=t.prototype,e.prototype=new n},__awaiter=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,a){function o(e){try{c(r.next(e))}catch(t){a(t)}}function s(e){try{c(r["throw"](e))}catch(t){a(t)}}function c(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(o,s)}c((r=r.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;c;)try{if(i=1,a&&(o=a[2&n[0]?"return":n[0]?"throw":"next"])&&!(o=o.call(a,n[1])).done)return o;switch(a=0,o&&(n=[0,o.value]),n[0]){case 0:case 1:o=n;break;case 4:return c.label++,{value:n[1],done:!1};case 5:c.label++,a=n[1],n=[0];continue;case 7:n=c.ops.pop(),c.trys.pop();continue;default:if(o=c.trys,!(o=o.length>0&&o[o.length-1])&&(6===n[0]||2===n[0])){c=0;continue}if(3===n[0]&&(!o||n[1]>o[0]&&n[1]<o[3])){c.label=n[1];break}if(6===n[0]&&c.label<o[1]){c.label=o[1],o=n;break}if(o&&c.label<o[2]){c.label=o[2],c.ops.push(n);break}o[2]&&c.ops.pop(),c.trys.pop();continue}n=t.call(e,c)}catch(r){n=[6,r],a=0}finally{i=o=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,a,o,s,c={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:n(0),"throw":n(1),"return":n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s},GameConfig=function(){function e(){}return e.getBasicUrl=function(){return this.basicUrl},e.getAppCode=function(){return this.appCode},e.getVersion=function(){return this.version},e.getShareTitle=function(){return this.shareTitle},e.getShareImg=function(){return this.shareImg},e.setStageWidthHeight=function(e){this.stageWidth=e.stageWidth,this.stageHeight=e.stageHeight},e.getWidth=function(){return this.stageWidth},e.getHeight=function(){return this.stageHeight},e.basicUrl="",e.appCode=1,e.version="1.0.0",e.shareTitle="分享标题",e.shareImg="imgUrl",e.stageWidth=0,e.stageHeight=0,e}();__reflect(GameConfig.prototype,"GameConfig");var Main=function(e){function t(){var t=e.call(this)||this;return StaticRes.loadPaths(),t.initReciver(),t}return __extends(t,e),t.prototype.initReciver=function(){var e=this;wx.onMessage(function(t){return __awaiter(e,void 0,void 0,function(){var e,n;return __generator(this,function(r){switch(r.label){case 0:switch(t.userInfo&&(UserData.userInfo=t.userInfo),t.token&&(UserData.token=t.token),UserData.shareTicket=t.shareTicket||"",t.isDisplay&&console.log("can display!"),UserData.type=t.type||"friend",e=null,n=UserData.type){case"friend":return[3,1];case"neighbor":return[3,3];case"group":return[3,5]}return[3,1];case 1:return[4,UserData.getFriendRanking().then(function(t){e=t})];case 2:return r.sent(),[3,7];case 3:return[4,UserData.getNeighborFriend(1).then(function(t){e=t})];case 4:return r.sent(),[3,7];case 5:return[4,UserData.getGroupRanking(UserData.shareTicket).then(function(t){e=t})];case 6:return r.sent(),[3,7];case 7:return console.log("获取数据完成"),console.log(e),[2]}})})})},t}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var eKit=function(){function e(){}return e.createBitmapByPath=function(e,t){return __awaiter(this,void 0,void 0,function(){var n,r,i;return __generator(this,function(a){switch(a.label){case 0:return n=new egret.Bitmap,r=null,[4,this.createTextureByPath(e).then(function(e){r=e})["catch"](function(e){console.warn(e)})];case 1:if(a.sent(),n.texture=r,t)for(i in t)n[i]=t[i];return[2,n]}})})},e.createTextureByPath=function(e){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(n){return[2,new Promise(function(n,r){var i=new egret.ImageLoader;i.addEventListener(egret.Event.COMPLETE,function(e){var t=e.currentTarget,r=new egret.Texture;r._setBitmapData(t.data),n(r)},t),i.load(e)})]})})},e.createText=function(e,t){var n=new egret.TextField;if(n.text=e,t)for(var r in t)n[r]=t[r];return n},e.createLine=function(e,t,n){var r=new egret.Shape;if(t.beginFill&&r.graphics.beginFill(t.beginFill.color,t.beginFill.alpha),t.lineStyle&&r.graphics.lineStyle(t.lineStyle.thickness,t.lineStyle.color,t.lineStyle.alpha,t.lineStyle.pixelHinting,t.lineStyle.scaleMode,t.lineStyle.caps,t.lineStyle.joints,t.lineStyle.miterLimit),r.graphics.moveTo(e[0][0],e[0][1]),e.map(function(t,n){n>0&&r.graphics.lineTo(e[n][0],e[n][1])}),r.graphics.endFill(),n)for(var i in n)r[i]=n[i];return r},e.createRect=function(e,t,n){var r=new egret.Shape;if(t.beginFill&&r.graphics.beginFill(t.beginFill.color,t.beginFill.alpha),t.lineStyle&&r.graphics.lineStyle(t.lineStyle.thickness,t.lineStyle.color,t.lineStyle.alpha,t.lineStyle.pixelHinting,t.lineStyle.scaleMode,t.lineStyle.caps,t.lineStyle.joints,t.lineStyle.miterLimit),r.graphics.drawRect(e[0],e[1],e[2],e[3]),n)for(var i in n)r[i]=n[i];return r},e.createCircle=function(e,t,n){var r=new egret.Shape;if(t.beginFill&&r.graphics.beginFill(t.beginFill.color,t.beginFill.alpha),t.lineStyle&&r.graphics.lineStyle(t.lineStyle.thickness,t.lineStyle.color,t.lineStyle.alpha,t.lineStyle.pixelHinting,t.lineStyle.scaleMode,t.lineStyle.caps,t.lineStyle.joints,t.lineStyle.miterLimit),r.graphics.drawCircle(e[0],e[1],e[2]),n)for(var i in n)r[i]=n[i];return r},e.createArc=function(e,t,n){var r=new egret.Shape;if(t.beginFill&&r.graphics.beginFill(t.beginFill.color,t.beginFill.alpha),t.lineStyle&&r.graphics.lineStyle(t.lineStyle.thickness,t.lineStyle.color,t.lineStyle.alpha,t.lineStyle.pixelHinting,t.lineStyle.scaleMode,t.lineStyle.caps,t.lineStyle.joints,t.lineStyle.miterLimit),r.graphics.drawArc(e[0],e[1],e[2],e[3],e[4],e[5]),n)for(var i in n)r[i]=n[i];return r},e.createRoundRect=function(e,t,n){var r=new egret.Shape;if(t.beginFill&&r.graphics.beginFill(t.beginFill.color,t.beginFill.alpha),t.lineStyle&&r.graphics.lineStyle(t.lineStyle.thickness,t.lineStyle.color,t.lineStyle.alpha,t.lineStyle.pixelHinting,t.lineStyle.scaleMode,t.lineStyle.caps,t.lineStyle.joints,t.lineStyle.miterLimit),r.graphics.drawArc(e[0],e[1],e[2],e[3],e[4],e[5]),n)for(var i in n)r[i]=n[i];return r},e.removeChild=function(e){e.parent&&e.parent.removeChild(e)},e.clearView=function(e,t){for(isNaN(t)&&(t=-1);e.$children.length>t+1;)e.removeChildAt(t+1);return!0},e}();__reflect(eKit.prototype,"eKit");var baseUrl=GameConfig.getBasicUrl(),app_code=GameConfig.getAppCode(),version=GameConfig.getVersion(),Api=function(){function e(){}return e.post=function(t,n){return __awaiter(this,void 0,void 0,function(){var r=this;return __generator(this,function(i){return[2,new Promise(function(i,a){e.token||a("token为空，请重新登陆");var o=new egret.HttpRequest;o.responseType=egret.HttpResponseType.TEXT,o.open(t,egret.HttpMethod.POST),o.setRequestHeader("Content-Type","application/json"),o.setRequestHeader("Authorization",e.token),o.send(n),o.addEventListener(egret.Event.COMPLETE,function(e){var t=e.currentTarget;i(JSON.parse(t.response))},r),o.addEventListener(egret.IOErrorEvent.IO_ERROR,function(e){a(e)},r)})]})})},e.get=function(t,n){return __awaiter(this,void 0,void 0,function(){var r=this;return __generator(this,function(i){return[2,new Promise(function(i,a){e.token||n||a("token为空，请重新登陆");var o=new egret.HttpRequest;o.responseType=egret.HttpResponseType.TEXT,o.open(t,egret.HttpMethod.GET),o.setRequestHeader("Authorization",e.token),o.send(),o.addEventListener(egret.Event.COMPLETE,function(e){var t=e.currentTarget;i(JSON.parse(t.response))},r),o.addEventListener(egret.IOErrorEvent.IO_ERROR,function(e){a(e)},r)})]})})},e.getToken=function(){return this.token},e.uploadRecords=function(t){return __awaiter(this,void 0,void 0,function(){var n;return __generator(this,function(r){switch(r.label){case 0:return n=!0,[4,e.post(e.uploadRecordsPath,t)["catch"](function(e){n=!1})];case 1:return r.sent(),[2,n]}})})},e.getBestRecord=function(t){return __awaiter(this,void 0,void 0,function(){var n;return __generator(this,function(r){switch(r.label){case 0:return n=null,[4,e.post(e.bestRecordPath,t).then(function(e){n=e})["catch"](function(e){n=null})];case 1:return r.sent(),[2,n]}})})},e.getRankings=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(n){switch(n.label){case 0:return t=null,wx.showLoading({title:"排行榜加载中...",mask:!0,success:function(){},fail:function(){},complete:function(){}}),[4,e.get(e.getRankingsPath).then(function(e){t=e})["catch"](function(e){t=null})];case 1:return n.sent(),wx.hideLoading(),[2,t]}})})},e.getShareUrl=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(n){switch(n.label){case 0:return t="",[4,e.get(e.getShareUrlPath).then(function(e){t=e.url})["catch"](function(e){t=""})];case 1:return n.sent(),[2,t]}})})},e.getTunnel=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(n){switch(n.label){case 0:return t=null,[4,e.get(e.tunnelPath).then(function(e){t=e})["catch"](function(e){t=null})];case 1:return n.sent(),[2,t]}})})},e.postEvent=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(n){if(isNaN(t)?t=this.event_type.indexOf(t)+1:this.event_type[t]||(t=0),0==t)throw new Error("事件传值不是预设的值");return e.post(e.postEventPath,{event_type:t}),[2]})})},e.getConfiguration=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(n){switch(n.label){case 0:return t=null,[4,e.get(e.configurationsPath+"?version="+version+"&app_code="+app_code,!0).then(function(e){t=e[0]})["catch"](function(e){console.warn(e)})];case 1:return n.sent(),[2,t]}})})},e.setToken=function(t){e.token=t},e.baseUrl=baseUrl,e.uploadRecordsPath=baseUrl+"/records",e.bestRecordPath=baseUrl+"/best_record",e.getRankingsPath=baseUrl+"/rankings",e.getShareUrlPath=baseUrl+"/share_url",e.getOpenIdPath=baseUrl+"/users",e.postEventPath=baseUrl+"/events",e.tunnelPath=baseUrl+"/tunnel",e.configurationsPath=baseUrl+"/configurations",e.event_type=["open","singleGame","uploadScore","replay","normalShare","groupResult","groupRank","reborn"],e}();__reflect(Api.prototype,"Api");var StaticRes=function(){function e(){}return e.loadPaths=function(){return __awaiter(this,void 0,void 0,function(){var e=this;return __generator(this,function(t){return this.RES=this.paths.map(function(t){return __awaiter(e,void 0,void 0,function(){var e;return __generator(this,function(n){switch(n.label){case 0:return[4,eKit.createBitmapByPath(t.path,t.settings)];case 1:return e=n.sent(),[2,{name:t.name,texture:e}]}})})}),[2]})})},e.getRes=function(e){var t=null;return this.RES.map(function(n){n.name==e&&(t=n.texture)}),t},e.paths=[{name:"bg",path:"resource/assets/bg.jpg",settings:{}}],e}();__reflect(StaticRes.prototype,"StaticRes");var UserData=function(){function e(){}return e.getFriendStorage=function(){return __awaiter(this,void 0,void 0,function(){var e=this;return __generator(this,function(t){return[2,new Promise(function(t,n){wx.getFriendCloudStorage({keyList:["score","date"],success:function(n){var r=new Array;n.data&&0!=n.data.length&&(n.data.forEach(function(t,n){var i=e.transObj(t.KVDataList);e.isInTimeRange(i.date)&&r.push({score:parseInt(i.score),date:i.date||"",openId:t.openid,user:{nickname:t.nickname,avatar_url:t.avatarUrl}})}),r.sort(function(e,t){var n=e.score,r=t.score;return r-n}),r=r.map(function(e,t){var n=JSON.parse(JSON.stringify(e));return n.rank=++t,n})),t(r)},fail:function(e){n(e)},complete:function(e){}})})]})})},e.getGroupStorage=function(e){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(n){return[2,new Promise(function(n,r){wx.getGroupCloudStorage({shareTicket:e,keyList:["score","date"],success:function(e){var r=new Array;e.data&&0!=e.data.length&&(e.data.forEach(function(e,n){var i=t.transObj(e.KVDataList);t.isInTimeRange(i.date)&&r.push({score:parseInt(i.score),date:i.date||"",openId:e.openid,user:{nickname:e.nickname,avatar_url:e.avatarUrl}})}),r.sort(function(e,t){var n=e.score,r=t.score;return r-n}),r=r.map(function(e,t){var n=JSON.parse(JSON.stringify(e));return n.rank=++t,n})),n(r)},fail:function(e){r(e)},complete:function(e){}})})]})})},e.getFriendRanking=function(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return e=null,[4,this.getFriendStorage().then(function(t){e=t})["catch"](function(e){console.warn(e)})];case 1:return t.sent(),this.friendRanking=e||[],[2,e]}})})},e.getNeighborFriend=function(t){return __awaiter(this,void 0,void 0,function(){var n,r,i,a,o,s;return __generator(this,function(c){switch(c.label){case 0:return n=e.userInfo.id,r=[],i=null,a=-1,t||(t=1),[4,this.getFriendStorage().then(function(e){i=e})["catch"](function(e){console.warn(e)})];case 1:if(c.sent(),i)if(i.length<=2*t+1)r=i;else{for(i.map(function(e,t){e.openId==n&&(a=t)}),o=-t,s=t;s>=o;o++)i[o]?r.push(i[a+o]):0>o?r.push(i[a+t+(t+o+1)]):r.push(i[a-t-(t-o+1)]);r.sort(function(e,t){return e.rank-t.rank})}return this.neighborRanking=r,[2,r]}})})},e.getGroupRanking=function(e){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(n){switch(n.label){case 0:return t=null,[4,this.getGroupStorage(e).then(function(e){t=e})["catch"](function(e){console.warn(e)})];case 1:return n.sent(),this.groupRanking=t||[],[2,t]}})})},e.getWeekTime=function(){var e=new Date,t=e.getFullYear(),n=e.getMonth(),r=e.getDate(),i=e.getDay(),a=new Date(t,n,r-(i?i-1:6)),o=new Date(t,n,r+(i?8-i:1));this.dateRange=[a.getTime(),o.getTime()]},e.isInTimeRange=function(e){if(e){var t=new Date(e.replace(/-/g,"/")).getTime();return t>this.dateRange[0]&&t<this.dateRange[1]}return!1},e.transObj=function(e){var t={};return e.map(function(e){t[e.key]=e.value}),t},e.keyList=["score","date"],e.dateRange=[],e.friendRanking=[],e.groupRanking=[],e.neighborRanking=[],e}();__reflect(UserData.prototype,"UserData"),UserData.getWeekTime();var VersionCtrl=function(){function e(){}return e.refreshVersionCtrl=function(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return e=this,[4,Api.getConfiguration()];case 1:return e.configuration=t.sent(),[2]}})})},e.queryConfig=function(e){return this.configuration[e]},e}();__reflect(VersionCtrl.prototype,"VersionCtrl"),window.Main=Main;